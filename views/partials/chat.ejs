<!-- Floating RoamMate Button -->
<div id="jarvis-btn" style="position: fixed; bottom: 30px; right: 30px; z-index: 999; transition: transform 0.3s ease;">
  <div
    style="position: relative; width: 60px; height: 60px; background: #ff385c; border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer; box-shadow: 0 4px 20px rgba(255, 56, 92, 0.4); border: 3px solid white;">
    <img src="/images/logo.svg?v=4" alt="Ask RoamMate" width="32" height="32" style="filter: brightness(0) invert(1);">
    <span
      style="position: absolute; top: -2px; right: -2px; width: 16px; height: 16px; background: #2ecc71; border-radius: 50%; border: 3px solid white;"></span>
  </div>
</div>

<!-- RoamMate Chatbot Popup -->
<div id="jarvis-popup" style="
  display: none;
  position: fixed;
  bottom: 110px;
  right: 30px;
  width: 350px;
  height: 480px;
  border-radius: 12px;
  z-index: 1000;
  display: none;
  flex-direction: column;
">
  <!-- Header -->
  <div class="chat-header">
    <div style="display: flex; align-items: center;">
      <img src="/images/logo.svg?v=4" class="bot-avatar-small" style="background: white; padding: 4px;">
      <span>RoamMate AI</span>
    </div>
    <span id="jarvis-close" style="cursor: pointer; font-size: 1.2rem; opacity: 0.8;">&times;</span>
  </div>

  <!-- Messages -->
  <div id="jarvis-chat" class="chat-messages">
    <div class="msg-bubble msg-bot">
      ğŸ‘‹ Hi! I'm <b>RoamMate</b>, your travel assistant.<br><br>
      I can help you with:<br>
      ğŸ  Find listings by location<br>
      ğŸ’° Check prices & budgets<br>
      ğŸ“… Booking assistance<br>
      ğŸ“ Customer support<br><br>
      Try asking: "Show me places in Nashik" or "How do I book?"
    </div>
  </div>

  <!-- Input -->
  <div class="chat-input-area">
    <div style="display: flex; gap: 8px;">
      <input type="text" id="jarvis-input" placeholder="Ask about places to stay..."
        style="flex: 1; padding: 10px; border-radius: 20px; border: 1px solid #e0e0e0; outline: none; font-size: 0.95rem;">
      <button id="jarvis-send" class="btn btn-primary"
        style="border-radius: 50%; width: 40px; height: 40px; padding: 0; display: flex; align-items: center; justify-content: center;">
        <i class="fa-solid fa-paper-plane" style="font-size: 0.9rem;"></i>
      </button>
    </div>
  </div>
</div>

<!-- Chat Logic -->
<script>
  const jarvisBtn = document.getElementById("jarvis-btn");
  const jarvisPopup = document.getElementById("jarvis-popup");
  const jarvisClose = document.getElementById("jarvis-close");
  const jarvisSend = document.getElementById("jarvis-send");
  const jarvisChat = document.getElementById("jarvis-chat");
  const jarvisInput = document.getElementById("jarvis-input");

  // Toggle Chat
  jarvisBtn.onclick = () => {
    if (jarvisPopup.style.display === "none" || jarvisPopup.style.display === "") {
      jarvisPopup.style.display = "flex";
      jarvisInput.focus();
    } else {
      jarvisPopup.style.display = "none";
    }
  };

  jarvisClose.onclick = () => {
    jarvisPopup.style.display = "none";
  };

  // Hover Effect
  jarvisBtn.onmouseover = () => jarvisBtn.style.transform = "scale(1.1)";
  jarvisBtn.onmouseout = () => jarvisBtn.style.transform = "scale(1)";

  // Send Logic
  const sendMessage = async () => {
    const userText = jarvisInput.value.trim();
    if (!userText) return;

    // Add User Message
    const userMsg = document.createElement("div");
    userMsg.className = "msg-bubble msg-user";
    userMsg.innerHTML = userText;
    jarvisChat.appendChild(userMsg);

    jarvisInput.value = "";
    jarvisChat.scrollTop = jarvisChat.scrollHeight;

    // Add Loading Bubble
    const loadingMsg = document.createElement("div");
    loadingMsg.className = "msg-bubble msg-bot";
    loadingMsg.innerHTML = `<i class="fa-solid fa-circle-notch fa-spin"></i> Thinking...`;
    jarvisChat.appendChild(loadingMsg);
    jarvisChat.scrollTop = jarvisChat.scrollHeight;

    try {
      const response = await fetch("/api/jarvis", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ message: userText }),
      });

      const data = await response.json();
      const reply = data.reply || "I'm having a bit of trouble connecting right now.";

      // Replace Loading with Reply
      loadingMsg.innerHTML = reply;

    } catch (err) {
      loadingMsg.innerHTML = "Sorry, I couldn't reach the server.";
    }
  };

  jarvisSend.onclick = sendMessage;
  jarvisInput.addEventListener("keypress", (e) => {
    if (e.key === "Enter") sendMessage();
  });
</script>